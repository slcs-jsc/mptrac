# KPP Chemical Integrator

This project uses the **Kinetic PreProcessor (KPP)** to solve chemical reaction systems. KPP is a widely used tool for generating code that integrates chemical reactions in atmospheric models. It converts chemical equations and mechanisms into C code that can be linked to large-scale models.

## Overview

The purpose of this repository is to provide a complete setup for solving chemical reaction systems using KPP. The primary files included are:

- `chem.eqn`: This file defines the chemical mechanism using a set of reactions.
- `chem.kpp`: The KPP input file used to generate the chemical solver code.
- `kpp_chem.h`: The header file containing the configuration and constants for the KPP-generated code.
- `Makefile`: The makefile to compile and build the chemical integration code.
- `build_KPP.sh`: A script to automate the process of building the KPP-generated code.

## Files and Their Roles

### 1. `chem.eqn`
This file contains the list of chemical reactions that define the chemical mechanism to be integrated. Each line in this file represents a chemical reaction, including the reactants, products, and reaction rates.
- #DEFVAR and #DEFFIX
There are two ways to declare new species together with their atom composition: #DEFVAR and #DEFFIX. These sections define all the species that will be used in the chemical mechanism. Species can be variable or fixed. The type is implicitly specified by defining the species in the appropriate sections. A fixed species does not vary through chemical reactions.
```
#DEFVAR
o3p   =   IGNORE;
o3    =   IGNORE;
#DEFFIX
o2    =   IGNORE;
```
- #EQUATIONS
The chemical mechanism is specified in the #EQUATIONS section.
```
#EQUATIONS
o3p + o2    = o3   : k0;
```
The reaction coefficient k0 should be defined in the function 
`void kpp_chem_initialize()`

The detail description of the user manual of KPP package can be found in https://kpp.readthedocs.io/en/stable/index.html

### 2. `chem.kpp`
This is the KPP mechanism file, which specifies the chemical species, parameters, and reactions. It is the primary input file used by KPP to generate the solver code.
This file comtain the declaration of the rate coefficient variables and the functions to initialize the species concentrations and rate coefficient (`kpp_chem_initialize()`) and output the species' volume mixing ratio back to MPTRAC (`kpp_chem_output2atm()`).

### 3. `kpp_chem.h`
This header file defines key parameters, constants, and functions used in the KPP-generated code. It includes the species involved in the chemical reactions and additional configurations necessary for the solver.

### 4. `Makefile`
This is the build configuration file used to compile the C or Fortran code generated by KPP. It includes instructions for linking the necessary libraries and compiling the source files.

### 5. `build_KPP.sh`
This script automates the process of generating and compiling the KPP code. It runs the KPP preprocessor on the specified mechanism (`chem.kpp`), compiles the generated code, and builds the executable.

## Prerequisites

The KPP package has been implemented in the libs folder. Execute  `/libs/build.sh -k` for the environment set up.

## Usage

1. **Modifying the chemical mechanism:** To modify the chemical reactions, edit the chem.eqn file. You can add, remove, or change the reactions and their rates. After modifying the file, run the build_KPP.sh script again to regenerate and recompile the solver code.

2. **Build the chemical integrator:**
  To build the solver using the KPP, run the provided build_KPP.sh script. This will generate the necessary C code and compile it with two parameter: 1) the directory of the folder where the kpp definition file is in, 2) the switch of GPU compilation:
  ```./build_KPP.sh <directory> <1:GPU on; 0:GPU off>```
  Example:
  ```./build.sh chem 0```

  The script will generate the chemical integration code from the chem.kpp and chem.eqn files, then compile it into an executable.

3. **Compile the source code of MPTRAC with `KPP=1`:** Go to the `src` directory and compile the code with the KPP mode switched on:
```
cd ../../src
make clean
make KPP=1
```

